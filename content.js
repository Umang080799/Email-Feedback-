
//JSON Object
parsed_obj = [{
  "category": "Email Etiquette",
  "subcategory": "Brevity",
  "textArea": "subjectContent",
  "text": "response upgradation of clearance sale old inventory management computer system",
  "section": "Subject",
  "length": [
    79
  ],
  "global_offset": [
    0
  ],
  "offset": [
    0
  ],
  "feedback": "Subject too long , an ideal subject should be between 40 to 70 characters."
},
{
  "category": "Email Etiquette",
  "subcategory": "Words Usage",
  "textArea": "subjectContent",
  "text": "response upgradation of clearance sale old inventory management computer system",
  "section": "Subject",
  "length": [
    4
  ],
  "global_offset": [
    34
  ],
  "offset": [
    34
  ],
  "feedback": "Usage of spammy words should be avoided."
},
{
  "category": "Email Etiquette",
  "subcategory": "Words Usage",
  "textArea": "subjectContent",
  "text": "response upgradation of clearance sale old inventory management computer system",
  "section": "Subject",
  "length": [
    9
  ],
  "global_offset": [
    24
  ],
  "offset": [
    24
  ],
  "feedback": "Usage of spammy words should be avoided."
},
{
  "category": "Email Etiquette",
  "subcategory": "Words Usage",
  "textArea": "subjectContent",
  "text": "response upgradation of clearance sale old inventory management computer system",
  "section": "Subject",
  "length": [
    8
  ],
  "global_offset": [
    0
  ],
  "offset": [
    0
  ],
  "feedback": "Using words/phrases like response at start of email subject should be avoided."
},
{
  "category": "Email Etiquette",
  "subcategory": "Capitalisation",
  "textArea": "subjectContent",
  "text": "response upgradation of clearance sale old inventory management computer system",
  "section": "Subject",
  "length": [
    8
  ],
  "global_offset": [
    0
  ],
  "offset": [
    0
  ],
  "feedback": "Subject should start with a capitalized letter."
},
{
  "category": "Email Etiquette",
  "subcategory": "Words Usage",
  "textArea": "emailContent",
  "text": "Hello Mr VinOd PaTHAK,",
  "section": "Salutation",
  "length": [
    22
  ],
  "global_offset": [
    0
  ],
  "offset": [
    0
  ],
  "feedback": "No need to write full name in such cases. Either make it Mr/Ms LastName or just FirstName"
},
{
  "category": "Email Etiquette",
  "subcategory": "Capitalisation",
  "textArea": "emailContent",
  "text": "Hello Mr VinOd PaTHAK,",
  "section": "Salutation",
  "length": [
    5
  ],
  "global_offset": [
    9
  ],
  "offset": [
    9
  ],
  "feedback": "A capital letter found in middle of a word."
},
{
  "category": "Email Etiquette",
  "subcategory": "Capitalisation",
  "textArea": "emailContent",
  "text": "Hello Mr VinOd PaTHAK,",
  "section": "Salutation",
  "length": [
    6
  ],
  "global_offset": [
    15
  ],
  "offset": [
    15
  ],
  "feedback": "A capital letter found in middle of a word."
},
{
  "category": "Email Etiquette",
  "subcategory": "Missing",
  "textArea": "emailContent",
  "text": "rajeev pathak,CSE,Heaven InfoTech",
  "section": "Closing",
  "length": [
    33
  ],
  "global_offset": [
    931
  ],
  "offset": [
    0
  ],
  "feedback": "Each and every mail should have a proper signoff which is missing in this case."
},
{
  "category": "Email Etiquette",
  "subcategory": "Capitalisation",
  "textArea": "emailContent",
  "text": "rajeev pathak,CSE,Heaven InfoTech",
  "section": "Closing",
  "length": [
    6
  ],
  "global_offset": [
    931
  ],
  "offset": [
    0
  ],
  "feedback": "Words should start with a capital letter."
},
{
  "category": "Email Etiquette",
  "subcategory": "Capitalisation",
  "textArea": "emailContent",
  "text": "rajeev pathak,CSE,Heaven InfoTech",
  "section": "Closing",
  "length": [
    6
  ],
  "global_offset": [
    938
  ],
  "offset": [
    7
  ],
  "feedback": "Words should start with a capital letter."
},
{
  "category": "Email Etiquette",
  "subcategory": "Wrong",
  "textArea": "emailContent",
  "text": "rajeev pathak,CSE,Heaven InfoTech",
  "section": "Closing",
  "length": [
    -1
  ],
  "global_offset": [
    930
  ],
  "offset": [
    -1
  ],
  "feedback": "Preferable to write each section of closing in new line."
},
{
  "category": "Email Etiquette",
  "subcategory": "Words Usage",
  "textArea": "emailContent",
  "text": "i am raj patel hope you are in good spirit, as discussed today please sir please i came to knw that ur company(superbazar) is looking up for replacement of your old inventary computer system",
  "section": "Email Body Opening",
  "length": [
    2
  ],
  "global_offset": [
    124
  ],
  "offset": [
    100
  ],
  "feedback": "It is not recommended to use such informal words in a business email."
},
{
  "category": "Email Etiquette",
  "subcategory": "Words Usage",
  "textArea": "emailContent",
  "text": "i am raj patel hope you are in good spirit, as discussed today please sir please i came to knw that ur company(superbazar) is looking up for replacement of your old inventary computer system",
  "section": "Email Body Opening",
  "length": [
    4,
    11,
    4,
    6,
    8,
    11,
    8,
    6
  ],
  "global_offset": [
    39,
    55,
    39,
    60,
    39,
    55,
    39,
    60
  ],
  "offset": [
    15,
    31,
    15,
    36,
    15,
    31,
    15,
    36
  ],
  "feedback": "This way of asking about someone's well being is not recommended."
},
{
  "category": "Email Etiquette",
  "subcategory": "Brevity",
  "textArea": "emailContent",
  "text": "i am raj patel hope you are in good spirit, as discussed today please sir please i came to knw that ur company(superbazar) is looking up for replacement of your old inventary computer system",
  "section": "Email Body Opening",
  "length": [
    6,
    6,
    3
  ],
  "global_offset": [
    87,
    98,
    94
  ],
  "offset": [
    63,
    74,
    70
  ],
  "feedback": "Too many kind words used, this type of language not recommended."
}
];


document.getElementById("btt").addEventListener("click", function () {
  var y = 1;
  var text1val = document.getElementById("box1").value;
  var update = "";
  var global_offset = [];
  var length = [];
  var flag = 0;
  var indexs = []; //array with the indexes of the repeating global_offsaets
  var new_global_offset = [];
  var compare = 0;
  var boolarr = [];
  var iterate = 0;
  var dict = [];
  var feedback = [];
  var dict_feed = []; //
  //////////////////////////////////////////////////////////////////////////////////////////
  for (x in parsed_obj) {   //for displaying the feedbacks of only the email content
    if (parsed_obj[x]["textArea"] == "emailContent") {
      // document.getElementById("parse").innerHTML += y + ":" + " " + parsed_obj[x]["feedback"] + "<br>";
      feedback.push(parsed_obj[x]["feedback"]);
      y += 1;
    }
  }
  ///////////////////////////////////////////////////////////////////////////////////////////// 
  for (s in parsed_obj) { // making an array of all the global offsets.
    if (parsed_obj[s]["textArea"] == "emailContent") {
      if (parsed_obj[s]["global_offset"].length > 1) {
        for (var w = 0; w < parsed_obj[s]["global_offset"].length; w++) {
          global_offset.push(parsed_obj[s]["global_offset"][w]);
        }
      } else {
        global_offset.push(parsed_obj[s]["global_offset"][0]);
      }
    }
  }

  //////////////////////////////////////////////////////////////////////////////////////
  for (var i = 0; i < global_offset.length; i++) { //boolean array to keep track of the repeating offset.
    boolarr.push('true');
  }

  for (var x = 0; x < global_offset.length; x++) {  //for making th duplicate index array. 
    compare = global_offset[x]
    for (var y = 0; y < global_offset.length; y++) {
      if ((global_offset[y] === compare) && (y !== x)) {
        boolarr[y] = false;
        boolarr[x] = false;
      }
    }
  }

  for (var z = 0; z < boolarr.length; z++) { //updating the indexes array
    if (!boolarr[z]) {
      indexs.push(z);
    }
  }

  ///////////////////////////////////////////////////////////////////////////////////////
  for (q in parsed_obj) {  //making an array with all the lengths of offsets. 
    if (parsed_obj[q]["textArea"] == "emailContent") {
      if (parsed_obj[q]["length"].length > 1) {
        for (var u = 0; u < parsed_obj[q]["length"].length; u++) {
          length.push(parsed_obj[q]["length"][u]);
        }
      } else {
        length.push(parsed_obj[q]["length"][0]);
      }
    }
  }

  ////////////////////////////////////////////////////////////////////////////////////////
  for (var i = 0; i < global_offset.length; i++) {  //making a dictionary woth global offset as keys and corresponding 
    //length as their corresponding lengths as values. 
    dict.push({
      key: global_offset[i],
      value: length[i],
    });
  }
  /////////////////////////////////////////////////////////////////////////////////////////////  
  dict.sort(function (a, b) { return a["key"] - b["key"] });  //array with only the unique global offsets 
  //with their max possible lengths.

  /////////////////////////////////////////////////////////////////////////////////////////////
  //making a new_global_offset with only unique offsets with the max possible length. 
  var unique_global_offset = [];
  var required_length = [];
  var index_val = global_offset.length - 1;
  var unique_length = [];

  var count = 0;
  var flagged = 0;
  for (var i = 0; i < dict.length - 1; i++) {   //we do -1 as we do i+1 
    var max = dict[i]["value"];
    while (dict[i]["key"] == dict[i + 1]["key"]) {
      if (dict[i + 1]["value"] > max) {
        max = dict[i + 1]["value"];
      }
      i++; //for looping through within the set. 
    }
    unique_global_offset.push(dict[i]["key"]);
    unique_length.push(max)
  }
  if (dict[dict.length - 1]["key"] != dict[dict.length - 2]["key"]) {
    unique_global_offset.push(dict[index_val]['key']);
    unique_length.push(dict[index_val]['value']);
  }

  ////////////////////////////////////////////////////////////////////////////////////////////
  //for handling the case when the errors overlap
  var sumation = [];
  for (var x = 0; x < unique_global_offset.length; x++) {
    sumation.push(unique_global_offset[x] + unique_length[x]);
  }

  var x = 0;
  var required_global_offset = [];
  var required_length = [];
  var sum = sumation[x];
  while (x < unique_length.length - 1) {

    if (sum > unique_global_offset[x + 1] && x == 0) {
      required_global_offset.push(unique_global_offset[x]);
      required_length.push(unique_length[x]);
    }
    while (sum > unique_global_offset[x + 1]) {
      x++;
    }
    x++;
    if (unique_global_offset[x] != undefined && unique_length[x] != undefined) {
      required_global_offset.push(unique_global_offset[x]);
      required_length.push(unique_length[x]);
      sum = sumation[x];
    }
  }
  console.log(required_global_offset);
  console.log(required_length);
  /////////////////////////////////////////////////////////////////////////////////////////////////

  //making a dictionary with the feedback and the global offset.
  for (var i = 0; i < required_global_offset.length; i++) {  //making a dictionary woth global offset as keys and corresponding 
    //feedback as their corresponding lengths as values. 
    dict_feed.push({
      key: feedback[i],
      value: feedback[i].length,
    }); 
  }
  /////////////////////////////////////////////////////////////////////////////////////////////////
  //required arrays are the final ones required. 
  var i = 0;
  var global = 0;

  update = text1val.slice()  //copies the text1val to the update. 
  for (var i = 0; i < required_global_offset.length; i++) {
    console.log(dict_feed[i].key);
    var feed = dict_feed[i].key;
    update = update.slice(0, required_global_offset[i]) //everything before the underline part
      + "<a class='test' data-toggle='tooltip' href = '#' data-trigger='hover' data-placement='bottom' title='"+feed+"' style='color:red'>" +
      update.slice(required_global_offset[i], required_global_offset[i] + required_length[i]) + "</a>" + //everything that needs to be underlined
      update.slice(required_global_offset[i] + required_length[i], update.length);  //everything after the underlined part. 
    for (var j = i + 1; j < required_global_offset.length; j++) //updating rest of the offsets due to addition of ,mark. and </mark>
      required_global_offset[j] += 125 + dict_feed[i]["value"];
  }
  ////////////////////////////////////////////////////////////////////////////////////////////
  document.getElementById("box1").innerHTML = text1val;
  document.getElementById("new").innerHTML = update;
  document.getElementById("box1").style.display = "none";

});
